<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>InvenTree Companion</title>
<link rel="icon" href="/static/favicon.ico">
<style>
  :root { --bg:#0b0c10; --panel:#12131a; --muted:#aab; --accent:#4cc3ff; --ok:#2ecc71; --err:#ff6574; }
  body{margin:0;background:var(--bg);color:#eee;font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;}
  .wrap{display:grid;grid-template-columns:240px 1fr;min-height:100vh}
  .side{background:var(--panel);padding:16px;border-right:1px solid #232436;position:sticky;top:0;height:100vh;overflow:auto}
  .brand{font-weight:700;margin-bottom:10px;color:#fff}
  .btn{display:block;width:100%;padding:10px 12px;margin:6px 0;border:1px solid #2a2b40;border-radius:10px;background:#171826;color:#e5e7eb;cursor:pointer;text-align:left}
  .btn.active{outline:2px solid var(--accent)}
  .content{padding:18px}
  h2{margin:10px 0 12px;font-size:20px}
  .card{background:#10111a;border:1px solid #202237;border-radius:14px;padding:14px;margin-bottom:14px}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .row > *{flex:1 1 220px}
  input,select,textarea{width:100%;padding:10px;background:#0f1117;border:1px solid #2a2b40;border-radius:10px;color:#e5e7eb}
  .pill{display:inline-flex;align-items:center;gap:8px;background:#0e1525;border:1px solid #1f2437;padding:6px 10px;border-radius:999px;color:#cbd5e1;font-size:12px}
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  th,td{padding:10px 12px;background:#0e111a;border:1px solid #1f2235}
  th{background:#121521;text-align:left;color:#c6d0f5}
  .actions{display:flex;gap:10px;flex-wrap:wrap}
  .imgbox{width:110px;height:110px;border-radius:10px;background:#090b12;border:1px solid #202237;display:flex;align-items:center;justify-content:center;overflow:hidden}
  .imgbox img{max-width:100%;max-height:100%;object-fit:cover}
  .ok{color:var(--ok)} .err{color:var(--err)}
  .tiny{font-size:12px;color:#b7c0d6}
  .note{color:#aab}
  .float-right{float:right}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media (max-width:900px){ .wrap{grid-template-columns:1fr} .side{position:static;height:auto} .btn{width:100%}}
</style>
</head>
<body>
<div class="wrap">
  <aside class="side">
    <div class="brand">InvenTree Companion</div>
    <button class="btn" id="nav-add">‚ûï Add / Capture</button>
    <button class="btn" id="nav-kiosk">üßæ Kiosk</button>
    <div class="card tiny">
      <div>Server: <span id="srv-url"></span></div>
    </div>
  </aside>

  <main class="content">
    <!-- ADD / CAPTURE PAGE -->
    <section id="page-add" style="display:none">
      <h2>Add New Part</h2>
      <div class="card">
        <div class="row">
          <div><label>IPN (optional)</label><input id="ipn" placeholder="e.g. M3x22-A2"/></div>
          <div><label>Name</label><input id="name" placeholder="Part name"/></div>
        </div>
        <div class="row">
          <div><label>Description</label><input id="desc" placeholder="Short description"/></div>
          <div><label>Initial Qty</label><input id="qty" type="number" step="0.01" /></div>
        </div>
        <div class="row">
          <div>
            <label>Location</label>
            <select id="loc"></select>
          </div>
          <div>
            <label>Image</label>
            <!-- camera first on mobile -->
            <input id="photo" type="file" accept="image/*" capture="environment" />
          </div>
        </div>
        <div class="actions">
          <button class="btn" id="btn-ai">‚ú® AI Suggest</button>
          <button class="btn" id="btn-create">Create Part</button>
        </div>
        <div id="add-status" class="tiny"></div>
      </div>
    </section>

    <!-- KIOSK PAGE -->
    <section id="page-kiosk" style="display:none">
      <h2>Kiosk</h2>
      <div class="card">
        <div class="row">
          <div><label>Search Part (name / IPN)</label><input id="kiosk-q" placeholder="e.g. DIN 912 M3" /></div>
          <div><label>&nbsp;</label><button class="btn" id="btn-search">Search</button></div>
        </div>
        <div id="kiosk-results" class="tiny note">Search results will appear here‚Ä¶</div>
      </div>

      <div class="card" id="part-detail" style="display:none">
        <div class="row">
          <div class="imgbox"><img id="part-img" alt=""></div>
          <div style="flex:3">
            <div class="pill" id="part-title"></div>
            <div class="tiny" id="part-ipn"></div>
          </div>
        </div>
      </div>

      <div class="card" id="stock-card" style="display:none">
        <div class="row">
          <div><label>Stock Items (select rows)</label></div>
        </div>
        <div class="row">
          <table id="stock-table">
            <thead><tr><th></th><th>ID</th><th>Qty</th><th>Location</th><th>Serial/Batch</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="row">
          <div>
            <label>Adjust Qty (selected stock)</label>
            <div class="grid2">
              <input id="delta" type="number" step="0.01" placeholder="+5 or -3" />
              <button class="btn" id="btn-adjust">Apply</button>
            </div>
            <div class="tiny note">Positive adds; negative removes.</div>
          </div>
        </div>
      </div>

      <!-- PRINT LABELS -->
      <div class="card" id="print-card" style="display:none">
        <h3 style="margin-top:0">Print Labels</h3>
        <div class="row">
          <div>
            <label>Model Type</label>
            <select id="label-model">
              <option value="stockitem">stockitem</option>
              <option value="part">part</option>
              <option value="stocklocation">stocklocation</option>
            </select>
          </div>
          <div>
            <label>Label Template</label>
            <select id="label-template"></select>
          </div>
          <div>
            <label>Printer Plugin (optional)</label>
            <select id="label-plugin">
              <option value="">(default)</option>
            </select>
          </div>
        </div>
        <div class="actions">
          <button class="btn" id="btn-load-templates">‚Üª Refresh Templates</button>
          <button class="btn" id="btn-print">üñ®Ô∏è Print</button>
        </div>
        <div class="tiny note">Select stock rows to print stockitem labels, or switch to ‚Äúpart‚Äù to print the part label.</div>
        <div id="print-status" class="tiny"></div>
      </div>
    </section>
  </main>
</div>

<script>
const API = "";
document.getElementById('srv-url').textContent = (location.origin);

const $ = (id)=>document.getElementById(id);
const show = (id)=>($(id).style.display='');
const hide = (id)=>($(id).style.display='none');

const navAdd = $('nav-add');
const navKiosk = $('nav-kiosk');
const pageAdd = $('page-add');
const pageKiosk = $('page-kiosk');

function setActive(btn){
  [navAdd, navKiosk].forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
}

navAdd.onclick = ()=>{ setActive(navAdd); show('page-add'); hide('page-kiosk'); };
navKiosk.onclick = ()=>{ setActive(navKiosk); show('page-kiosk'); hide('page-add'); };

navKiosk.click(); // default

// ---------- Add Page ----------
async function loadLocations(){
  const res = await fetch(API + '/api/locations');
  const data = await res.json();
  const sel = $('loc');
  sel.innerHTML = '';
  for (const r of data){
    const o = document.createElement('option');
    o.value = r.pk; o.textContent = r.path;
    sel.appendChild(o);
  }
}
loadLocations();

$('btn-ai').onclick = async ()=>{
  const prompt = $('name').value || $('ipn').value || '';
  if(!prompt){ $('add-status').textContent = 'Enter something first'; return; }
  $('add-status').textContent = 'Asking AI‚Ä¶';
  try{
    const res = await fetch(API + '/api/ai/suggest-part',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt,strict:true})});
    if(!res.ok){ throw new Error(await res.text()); }
    const data = await res.json();
    $('name').value = data.name || $('name').value;
    $('desc').value = data.description || $('desc').value;
    $('add-status').innerHTML = `<span class="ok">AI OK</span>`;
  }catch(e){ $('add-status').innerHTML = `<span class="err">AI error: ${e}</span>`; }
};

$('btn-create').onclick = async ()=>{
  const fd = new FormData();
  fd.append('name', $('name').value);
  if($('desc').value) fd.append('description', $('desc').value);
  if($('ipn').value) fd.append('ipn', $('ipn').value);
  if($('qty').value) fd.append('initial_qty', $('qty').value);
  if($('loc').value) fd.append('location_id', $('loc').value);

  $('add-status').textContent = 'Creating‚Ä¶';
  try{
    const res = await fetch(API + '/api/part/create',{method:'POST', body: fd});
    if(!res.ok){ throw new Error(await res.text()); }
    const data = await res.json();
    $('add-status').innerHTML = `<span class="ok">Part created (ID ${data.pk})</span>`;

    // If an image is chosen, upload it
    const file = $('photo').files[0];
    if(file){
      const up = new FormData();
      up.append('part_id', data.pk);
      up.append('image', file);
      const r2 = await fetch(API + '/api/upload',{method:'POST', body: up});
      if(!r2.ok){ throw new Error(await r2.text()); }
      $('add-status').innerHTML += ` ¬∑ <span class="ok">Image uploaded</span>`;
    }
  }catch(e){
    $('add-status').innerHTML = `<span class="err">Error: ${e}</span>`;
  }
};

// Prefer camera on mobile when tapping the file input (already using capture attr)


// ---------- Kiosk ----------
let currentPart = null;
let currentPartImage = null;

$('btn-search').onclick = async ()=>{
  const q = $('kiosk-q').value.trim();
  if(!q){ $('kiosk-results').textContent = 'Enter search text'; return; }
  $('kiosk-results').textContent = 'Searching‚Ä¶';
  try{
    const res = await fetch(API + '/api/parts?q='+encodeURIComponent(q));
    const parts = await res.json();
    if(!Array.isArray(parts) || parts.length === 0){
      $('kiosk-results').textContent = 'No results';
      hide('part-detail'); hide('stock-card'); hide('print-card');
      return;
    }
    // Pick first result for simplicity
    const p = parts[0];
    currentPart = p.pk;

    // image: prefer full image if thumbnail present
    let img = p.image || p.thumbnail || '';
    if(img && img.includes('.thumbnail')) {
      img = img.replace('.thumbnail',''); // use original
    }
    currentPartImage = img ? (img.startsWith('http')? img : (new URL(img, location.origin)).href) : '';

    $('part-title').textContent = `${p.name}  (ID ${p.pk})`;
    $('part-ipn').textContent = p.ipn ? `IPN: ${p.ipn}` : '';
    $('part-img').src = currentPartImage || '';
    show('part-detail');

    // load stock
    const sres = await fetch(API + '/api/stock/by-part?part='+p.pk);
    const rows = await sres.json();
    const tbody = $('stock-table').querySelector('tbody');
    tbody.innerHTML = '';
    for (const r of rows){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="checkbox" class="chk" value="${r.pk}"></td>
        <td>${r.pk}</td>
        <td>${r.quantity}</td>
        <td>${r.location || ''}</td>
        <td>${r.serial || r.batch || ''}</td>
      `;
      tbody.appendChild(tr);
    }
    show('stock-card');
    // prepare print panel
    $('label-model').value = 'stockitem';
    await refreshPlugins();
    await refreshTemplates();
    show('print-card');

    $('kiosk-results').textContent = `${parts.length} result(s). Showing first.`;
  }catch(e){
    $('kiosk-results').innerHTML = `<span class="err">Error: ${e}</span>`;
    hide('part-detail'); hide('stock-card'); hide('print-card');
  }
};

$('btn-adjust').onclick = async ()=>{
  const checks = Array.from(document.querySelectorAll('#stock-table .chk:checked'));
  if(checks.length === 0){ alert('Select at least one stock item'); return; }
  const delta = parseFloat($('delta').value);
  if(!delta){ alert('Enter delta (e.g., +5 or -3)'); return; }
  for (const c of checks){
    const fd = new FormData();
    fd.append('stock_id', c.value);
    fd.append('delta', delta);
    await fetch(API + '/api/stock/adjust',{method:'POST', body: fd});
  }
  $('btn-search').click(); // refresh
};

// ---------- Labels / Printing ----------
$('label-model').onchange = ()=>refreshTemplates();
$('btn-load-templates').onclick = ()=>refreshTemplates();

async function refreshTemplates(){
  const model = $('label-model').value;
  const res = await fetch(API + `/api/labels/templates?model_type=${model}&enabled=true`);
  const data = await res.json();
  const sel = $('label-template');
  sel.innerHTML = '';
  for (const t of data){
    const o = document.createElement('option');
    o.value = t.pk; o.textContent = `${t.name} (${t.model_type})`;
    sel.appendChild(o);
  }
}

async function refreshPlugins(){
  const res = await fetch(API + `/api/plugins/label?active=true`);
  const data = await res.json();
  const sel = $('label-plugin');
  sel.innerHTML = '<option value="">(default)</option>';
  for (const p of data){
    const o = document.createElement('option');
    o.value = p.pk; o.textContent = `${p.name} ${p.active ? '' : '(inactive)'}`;
    sel.appendChild(o);
  }
}

$('btn-print').onclick = async ()=>{
  const model = $('label-model').value;
  const t = $('label-template').value;
  const plugin = $('label-plugin').value;

  // Gather items
  let items = [];
  if(model === 'stockitem'){
    items = Array.from(document.querySelectorAll('#stock-table .chk:checked')).map(c=>Number(c.value));
    if(items.length === 0){ alert('Select at least one stock item to print'); return; }
  } else if (model === 'part') {
    if(!currentPart){ alert('Search a part first'); return; }
    items = [Number(currentPart)];
  } else {
    alert('Select items for stocklocation printing manually (not implemented here).');
    return;
  }

  $('print-status').textContent = 'Sending job‚Ä¶';
  try{
    const body = { template_id: Number(t), items: items };
    if(plugin) body.plugin_id = Number(plugin);
    const res = await fetch(API + '/api/labels/print',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
    if(!res.ok){ throw new Error(await res.text()); }
    $('print-status').innerHTML = `<span class="ok">Print job sent</span>`;
  }catch(e){
    $('print-status').innerHTML = `<span class="err">${e}</span>`;
  }
};
</script>
</body>
</html>
