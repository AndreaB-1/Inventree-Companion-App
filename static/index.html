<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>InvenTree Companion</title>
<style>
  :root{
    --bg:#0f1115;--panel:#151921;--muted:#8b93a7;--text:#e7eaf1;--brand:#5aa6ff;--brand-2:#1f6feb;--ok:#22c55e;--err:#ef4444;--border:#232838;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  a{color:var(--brand)}
  .app{display:grid;grid-template-columns:260px 1fr;min-height:100dvh}
  @media (max-width: 900px){
    .app{grid-template-columns:1fr}
    .sidebar{position:fixed;inset:0 40% 0 0;transform:translateX(-100%);transition:transform .2s;z-index:40}
    .sidebar.open{transform:translateX(0)}
    .backdrop{display:none}
    .sidebar.open + .backdrop{display:block;position:fixed;inset:0;background:#0007;z-index:30}
  }
  header{display:flex;align-items:center;gap:12px;padding:14px 16px;background:var(--panel);border-bottom:1px solid var(--border)}
  .hamb{display:none}
  @media (max-width:900px){
    .hamb{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border:1px solid var(--border);border-radius:10px;background:#0e1220;box-shadow:0 0 0 1px #0a0d16 inset;cursor:pointer}
  }
  .sidebar{background:var(--panel);border-right:1px solid var(--border);padding:14px;z-index:40}
  .logo{font-weight:700;color:#cdd9ff;letter-spacing:.3px;margin-bottom:10px}
  .menu{display:flex;flex-direction:column;gap:6px}
  .menu button{all:unset;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#0e1220;box-shadow:0 0 0 1px #0a0d16 inset;cursor:pointer}
  .menu button.active{background:linear-gradient(180deg,#0e1424,#0b1020);}
  .menu small{display:block;color:var(--muted);margin:6px 2px 2px}

  .page{padding:18px}
  .container{max-width:1000px;margin:0 auto;display:flex;flex-direction:column;gap:14px}
  .card{background:linear-gradient(180deg,#111624,#0b0f1b);border:1px solid var(--border);border-radius:16px;padding:14px}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:flex-end}
  .col{display:flex;flex-direction:column;gap:6px;min-width:180px;flex:1}
  label{color:var(--muted);font-size:.9rem}
  input, textarea, select{background:#0e1220;border:1px solid var(--border);border-radius:12px;color:var(--text);padding:10px 12px;outline:none}
  textarea{min-height:84px;resize:vertical}
  .btn{all:unset;display:inline-flex;align-items:center;justify-content:center;padding:10px 14px;border-radius:12px;border:1px solid #0b1222;background:linear-gradient(180deg,#0e1424,#0b1020);cursor:pointer}
  .btn.primary{background:linear-gradient(180deg,#1a2a4a,#12213f);border-color:#1b2b4b}
  .btn.ok{background:linear-gradient(180deg,#0f3a22,#0c2f1c);border-color:#125a2d}
  .btn.warn{background:linear-gradient(180deg,#3a1212,#2a0e0e);border-color:#5a1a1a}
  .muted{color:var(--muted)}
  .status{font-size:.92rem}
  .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#0e1220;color:var(--muted);font-size:.86rem}
  .thumb{width:110px;height:110px;border-radius:12px;background:#0e1220;border:1px solid var(--border);object-fit:cover}
  .list{display:flex;flex-direction:column;gap:10px}
  .stock-card{display:flex;gap:12px;align-items:flex-start;border:1px dashed var(--border);border-radius:12px;padding:10px}
  .grow{flex:1}
  .right{margin-left:auto}
  .dropdown{position:relative}
  .dropdown-list{position:absolute;z-index:10;left:0;right:0;top:100%;max-height:280px;overflow:auto;background:#0e1220;border:1px solid var(--border);border-radius:12px;margin-top:6px;padding:6px;display:none}
  .dropdown.open .dropdown-list{display:block}
  .dropdown-item{padding:8px;border-radius:8px;cursor:pointer}
  .dropdown-item:hover{background:#171b29}
</style>
</head>
<body>
<div id="backdrop" class="backdrop"></div>
<div class="app">
  <!-- Sidebar -->
  <aside id="sidebar" class="sidebar">
    <div class="logo">InvenTree Companion</div>
    <div class="menu">
      <small>PAGES</small>
      <button id="nav-add" class="active" onclick="showPage('add')">‚ûï Add Component</button>
      <button id="nav-kiosk" onclick="showPage('kiosk')">üóÇÔ∏è Kiosk (Stock)</button>
    </div>
  </aside>

  <!-- Main -->
  <main>
    <header>
      <button class="hamb" onclick="toggleSidebar()">‚ò∞</button>
      <div class="muted">Open on phone via <code>http://SERVER:8000/</code></div>
    </header>

    <!-- ADD PAGE -->
    <section id="page-add" class="page">
      <div class="container">
        <!-- Part Search -->
        <div class="card">
          <h3 style="margin:0 0 10px 0;">Select Existing Part (optional)</h3>
          <div class="row">
            <div class="col dropdown" id="partSearchWrap">
              <label>Search part (name or IPN)</label>
              <input id="partSearch" placeholder="Type to search‚Ä¶" autocomplete="off" />
              <div id="partSearchList" class="dropdown-list"></div>
              <small class="muted" id="partSearchStatus"></small>
            </div>
            <div class="col">
              <label>Selected Part</label>
              <input id="selectedPartLabel" readonly placeholder="None" />
              <input type="hidden" id="selectedPartId" />
            </div>
            <div class="col" style="max-width:140px">
              <label>Image</label>
              <img id="selectedPartThumb" class="thumb" alt="No image" />
            </div>
          </div>
        </div>

        <!-- AI Suggest -->
        <div class="card">
          <h3 style="margin:0 0 10px 0;">AI Suggest (optional)</h3>
          <div class="row">
            <div class="col" style="min-width:260px">
              <label>Prompt</label>
              <textarea id="aiPrompt" placeholder="e.g. M3x22 A2 DIN 912; BC548; RJ45 CAT6 shielded pass-through"></textarea>
            </div>
            <div class="col" style="min-width:220px">
              <label>&nbsp;</label>
              <div class="row" style="gap:8px;align-items:center;">
                <button id="aiSuggest" class="btn">AI Suggest</button>
                <label class="muted" style="display:flex;align-items:center;gap:6px;">
                  <input type="checkbox" id="aiNameOnly" /> Name only
                </label>
                <label class="muted" style="display:flex;align-items:center;gap:6px;">
                  <input type="checkbox" id="aiStrict" checked /> Strict
                </label>
              </div>
              <div class="status" id="aiStatus"></div>
            </div>
          </div>
        </div>

        <!-- Create Part -->
        <div class="card">
          <h3 style="margin:0 0 10px 0;">Create / Update Part</h3>
          <div class="row">
            <div class="col">
              <label>Name</label>
              <input id="newName" placeholder="M3 √ó 22 ‚Äì Socket Head Cap Screw A2" />
            </div>
            <div class="col">
              <label>IPN (optional)</label>
              <input id="newIPN" placeholder="Internal Part Number" />
            </div>
          </div>
          <div class="row">
            <div class="col">
              <label>Description</label>
              <textarea id="newDesc" placeholder="M3 √ó 22 ‚Äì Socket Head Cap Screw ‚Äì DIN 912 ‚Äì A2 Stainless Steel"></textarea>
            </div>
          </div>
          <div class="row">
            <div class="col" style="min-width:150px">
              <label>Initial Qty (optional)</label>
              <input id="newQty" type="number" step="0.01" placeholder="100" />
            </div>
            <div class="col dropdown" id="locSearchWrap">
              <label>Location (for initial qty)</label>
              <input id="locSearch" placeholder="Type to search location‚Ä¶" autocomplete="off" />
              <div id="locSearchList" class="dropdown-list"></div>
              <input type="hidden" id="locId" />
            </div>
          </div>
          <div class="row" style="gap:8px;align-items:center;">
            <button class="btn primary" id="btnCreate">Create Part</button>
            <span id="createStatus" class="status"></span>
          </div>
        </div>

        <!-- Upload Image -->
        <div class="card">
          <h3 style="margin:0 0 10px 0;">Upload Image (thumbnail)</h3>
          <div class="row">
            <div class="col" style="min-width:240px">
              <label>Target Part ID</label>
              <input id="uploadPartId" placeholder="Auto-fills when you select/create a part" />
            </div>
            <div class="col" style="min-width:240px">
              <label>Image file</label>
              <input id="uploadFile" type="file" accept="image/*" />
            </div>
          </div>
          <div class="row" style="gap:8px;align-items:center;">
            <button class="btn" id="btnUpload">Upload</button>
            <span id="uploadStatus" class="status"></span>
          </div>
        </div>
      </div>
    </section>

    <!-- KIOSK PAGE -->
    <section id="page-kiosk" class="page" hidden>
      <div class="container">
        <div class="card">
          <h3 style="margin:0 0 10px 0;">Find Part</h3>
          <div class="row">
            <div class="col dropdown" id="kioskSearchWrap">
              <label>Part (name/IPN or ID)</label>
              <input id="kioskQuery" placeholder="Start typing‚Ä¶ or paste Part ID" autocomplete="off" />
              <div id="kioskSearchList" class="dropdown-list"></div>
              <small class="muted" id="kioskStatus"></small>
            </div>
            <div class="col">
              <label>Selected Part</label>
              <input id="kioskPartLabel" readonly />
              <input type="hidden" id="kioskPartId" />
            </div>
            <div class="col" style="max-width:140px">
              <label>Image</label>
              <img id="kioskThumb" class="thumb" alt="No image" />
            </div>
          </div>
        </div>

        <div class="card">
          <h3 style="margin:0 0 10px 0;">Stock Items</h3>
          <div id="stockList" class="list"></div>
          <div id="stockEmpty" class="muted">No stock items yet.</div>
        </div>
      </div>
    </section>
  </main>
</div>

<script>
  // ---------- Layout ----------
  const sidebar = document.getElementById('sidebar');
  const backdrop = document.getElementById('backdrop');
  function toggleSidebar(){ sidebar.classList.toggle('open'); }
  backdrop.onclick = () => sidebar.classList.remove('open');

  function showPage(id){
    document.getElementById('page-add').hidden = id !== 'add';
    document.getElementById('page-kiosk').hidden = id !== 'kiosk';
    document.getElementById('nav-add').classList.toggle('active', id==='add');
    document.getElementById('nav-kiosk').classList.toggle('active', id==='kiosk');
    sidebar.classList.remove('open');
  }

  // ---------- HTTP helpers ----------
  async function apiGET(url){
    const r = await fetch(url);
    let body = null;
    try { body = await r.json(); } catch {}
    if(!r.ok) throw new Error((body && body.detail) || `GET ${url} failed`);
    return body;
  }
  async function apiPOST(url, payload){
    const r = await fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
    const body = await r.json().catch(()=> ({}));
    if(!r.ok) throw new Error(body.detail || `POST ${url} failed`);
    return body;
  }

  // ---------- Typeahead ----------
  function attachTypeahead({inputEl, listEl, onQuery, onPick}){
    let timer=null;
    const wrap = inputEl.closest('.dropdown');
    inputEl.addEventListener('input', ()=>{
      const q = inputEl.value.trim();
      if(timer) clearTimeout(timer);
      if(!q){ listEl.innerHTML=''; wrap.classList.remove('open'); return; }
      timer = setTimeout(async ()=>{
        try{
          const items = await onQuery(q);
          if(!items.length){ listEl.innerHTML = `<div class="dropdown-item muted">No results</div>`; wrap.classList.add('open'); return; }
          listEl.innerHTML = items.map(it => `<div class="dropdown-item" data-pk="${it.pk}">${it.label}</div>`).join('');
          wrap.classList.add('open');
        }catch(e){
          listEl.innerHTML = `<div class="dropdown-item muted">Error: ${e.message}</div>`;
          wrap.classList.add('open');
        }
      }, 150);
    });
    listEl.addEventListener('click', (e)=>{
      const item = e.target.closest('.dropdown-item');
      if(!item) return;
      const pk = item.getAttribute('data-pk');
      const label = item.textContent;
      inputEl.value = label;
      wrap.classList.remove('open');
      onPick({pk, label});
    });
    document.addEventListener('click', (e)=>{
      if(!wrap.contains(e.target)){ wrap.classList.remove('open'); }
    });
  }

  // ---------- Part Search (Add page) ----------
  const partSearch = document.getElementById('partSearch');
  const partSearchList = document.getElementById('partSearchList');
  const partSearchStatus = document.getElementById('partSearchStatus');
  const selectedPartLabel = document.getElementById('selectedPartLabel');
  const selectedPartId = document.getElementById('selectedPartId');
  const selectedPartThumb = document.getElementById('selectedPartThumb');
  const uploadPartId = document.getElementById('uploadPartId');

  attachTypeahead({
    inputEl: partSearch,
    listEl: partSearchList,
    onQuery: async (q)=>{
      const rows = await apiGET(`/api/parts?q=${encodeURIComponent(q)}&limit=10`);
      return rows.map(r=>({pk:r.pk, label:`${r.name}${r.ipn?` (IPN: ${r.ipn})`:''}`}));
    },
    onPick: ({pk, label})=>{
      selectedPartLabel.value = label;
      selectedPartId.value = pk;
      uploadPartId.value = pk;
      partSearchStatus.textContent = `Selected Part ID: ${pk}`;
      selectedPartThumb.onerror = () => selectedPartThumb.removeAttribute('src');
      selectedPartThumb.src = `/api/part/image-proxy?pk=${pk}&_=${Date.now()}`;
    }
  });

  // ---------- Location search (Add page) ----------
  const locSearch = document.getElementById('locSearch');
  const locList = document.getElementById('locSearchList');
  const locId = document.getElementById('locId');

  attachTypeahead({
    inputEl: locSearch,
    listEl: locList,
    onQuery: async (q)=>{
      const rows = await apiGET(`/api/locations?q=${encodeURIComponent(q)}&limit=12`);
      return rows.map(r=>({pk:r.pk, label:r.path || r.name}));
    },
    onPick: ({pk, label})=>{
      locId.value = pk;
      locSearch.value = label;
    }
  });

  // ---------- AI Suggest ----------
  const aiBtn = document.getElementById('aiSuggest');
  const aiPromptEl = document.getElementById('aiPrompt');
  const aiStatus = document.getElementById('aiStatus');
  const aiNameOnlyEl = document.getElementById('aiNameOnly');
  const aiStrictEl = document.getElementById('aiStrict');

  aiBtn.onclick = async ()=>{
    const prompt = aiPromptEl.value.trim();
    if(!prompt){ aiStatus.textContent = 'Type something first.'; return; }
    aiStatus.textContent = 'Thinking‚Ä¶';
    try{
      const r = await fetch('/api/ai/suggest-part', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          prompt,
          language: (navigator.language||'en').slice(0,2),
          name_only: !!aiNameOnlyEl.checked,
          strict: !!aiStrictEl.checked
        })
      });
      const j = await r.json();
      if(!r.ok) throw new Error(j.detail || 'AI failed');

      document.getElementById('newName').value = j.name || '';
      if(!aiNameOnlyEl.checked){
        document.getElementById('newDesc').value = j.description || '';
      }
      aiStatus.textContent = '‚úÖ Suggested. Review, then Create.';
    }catch(e){
      aiStatus.textContent = '‚ùå ' + e.message;
    }
  };

  // ---------- Create Part ----------
  const btnCreate = document.getElementById('btnCreate');
  const createStatus = document.getElementById('createStatus');

  btnCreate.onclick = async ()=>{
    const name = document.getElementById('newName').value.trim();
    const description = document.getElementById('newDesc').value.trim();
    const ipn = document.getElementById('newIPN').value.trim();
    const qty = document.getElementById('newQty').value.trim();
    const location_id = document.getElementById('locId').value.trim();

    if(!name){ createStatus.textContent='‚ùå Name required'; return; }
    createStatus.textContent = 'Saving‚Ä¶';

    const fd = new FormData();
    fd.append('name', name);
    if(description) fd.append('description', description);
    if(ipn) fd.append('ipn', ipn);
    if(qty) fd.append('initial_qty', qty);
    if(qty && location_id) fd.append('location_id', location_id);

    try{
      const r = await fetch('/api/part/create',{method:'POST', body:fd});
      const j = await r.json();
      if(!r.ok) throw new Error(j.detail || 'Create failed');

      createStatus.textContent = '‚úÖ ' + (j.message || 'Created');
      selectedPartLabel.value = `${j.name} (ID ${j.pk})`;
      selectedPartId.value = j.pk;
      uploadPartId.value = j.pk;
      selectedPartThumb.onerror = () => selectedPartThumb.removeAttribute('src');
      selectedPartThumb.src = `/api/part/image-proxy?pk=${j.pk}&_=${Date.now()}`;
    }catch(e){
      createStatus.textContent = '‚ùå ' + e.message;
    }
  };

  // ---------- Upload image ----------
  const btnUpload = document.getElementById('btnUpload');
  const uploadStatus = document.getElementById('uploadStatus');

  btnUpload.onclick = async ()=>{
    const pid = (document.getElementById('uploadPartId').value || '').trim();
    const file = document.getElementById('uploadFile').files[0];
    if(!pid){ uploadStatus.textContent='‚ùå Part ID required'; return; }
    if(!file){ uploadStatus.textContent='‚ùå Pick an image'; return; }
    uploadStatus.textContent = 'Uploading‚Ä¶';

    const fd = new FormData();
    fd.append('part_id', pid);
    fd.append('image', file);

    try{
      const r = await fetch('/api/upload',{method:'POST', body:fd});
      const j = await r.json();
      if(!r.ok) throw new Error(j.detail || 'Upload failed');

      uploadStatus.textContent = '‚úÖ Uploaded';
      selectedPartThumb.onerror = () => selectedPartThumb.removeAttribute('src');
      selectedPartThumb.src = `/api/part/image-proxy?pk=${pid}&_=${Date.now()}`;

      if(document.getElementById('kioskPartId').value == pid){
        kioskThumb.onerror = () => kioskThumb.removeAttribute('src');
        kioskThumb.src = `/api/part/image-proxy?pk=${pid}&_=${Date.now()}`;
      }
    }catch(e){
      uploadStatus.textContent = '‚ùå ' + e.message;
    }
  };

  // ---------- Kiosk search & stock ----------
  const kioskQuery = document.getElementById('kioskQuery');
  const kioskList = document.getElementById('kioskSearchList');
  const kioskStatus = document.getElementById('kioskStatus');
  const kioskPartId = document.getElementById('kioskPartId');
  const kioskPartLabel = document.getElementById('kioskPartLabel');
  const kioskThumb = document.getElementById('kioskThumb');
  const stockList = document.getElementById('stockList');
  const stockEmpty = document.getElementById('stockEmpty');

  attachTypeahead({
    inputEl: kioskQuery,
    listEl: kioskList,
    onQuery: async (q)=>{
      const rows = await apiGET(`/api/parts?q=${encodeURIComponent(q)}&limit=10`);
      return rows.map(r=>({pk:r.pk, label:`${r.name}${r.ipn?` (IPN: ${r.ipn})`:''}`}));
    },
    onPick: ({pk, label})=> loadKioskPart(pk, label)
  });

  kioskQuery.addEventListener('keydown', async (e)=>{
    if(e.key==='Enter'){
      const q = kioskQuery.value.trim();
      if(!q) return;
      // numeric id?
      if(/^\d+$/.test(q)){
        try{
          const p = await apiGET(`/api/part/by-id?pk=${q}`);
          return loadKioskPart(p.pk, `${p.name}${p.ipn?` (IPN: ${p.ipn})`:''}`);
        }catch{}
      }
      // first search hit
      try{
        const rows = await apiGET(`/api/parts?q=${encodeURIComponent(q)}&limit=1`);
        if(rows.length){ loadKioskPart(rows[0].pk, `${rows[0].name}${rows[0].ipn?` (IPN: ${rows[0].ipn})`:''}`); }
        else kioskStatus.textContent = 'No results';
      }catch(e){ kioskStatus.textContent = '‚ùå ' + e.message; }
    }
  });

  async function loadKioskPart(pk, label){
    kioskPartId.value = pk;
    kioskPartLabel.value = label || `ID ${pk}`;
    kioskStatus.textContent = `Part ID: ${pk}`;
    kioskThumb.onerror = () => kioskThumb.removeAttribute('src');
    kioskThumb.src = `/api/part/image-proxy?pk=${pk}&_=${Date.now()}`;
    await refreshStock(pk);
  }

  async function refreshStock(partId){
    try{
      const items = await apiGET(`/api/stock/by-part?part_id=${partId}`);
      stockList.innerHTML = '';
      if(!items.length){ stockEmpty.style.display='block'; return; }
      stockEmpty.style.display='none';
      for(const it of items){
        const id = it.pk;
        const row = document.createElement('div');
        row.className = 'stock-card';
        row.innerHTML = `
          <div class="grow">
            <div><strong>Stock #${id}</strong> ‚Äî <span class="pill">${(it.location_path||'No location')}</span></div>
            <div class="muted">Qty: <strong>${it.quantity}</strong></div>
            ${it.batch ? `<div class="muted">Batch: ${it.batch}</div>` : ``}
            ${it.serial ? `<div class="muted">Serial: ${it.serial}</div>` : ``}
          </div>
          <div class="right" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            <input class="pill" style="width:110px" placeholder="Remove‚Ä¶" inputmode="decimal" id="rm-${id}">
            <button class="btn warn" id="btn-rm-${id}">Remove</button>
            <input class="pill" style="width:110px" placeholder="Add‚Ä¶" inputmode="decimal" id="ad-${id}">
            <button class="btn ok" id="btn-ad-${id}">Add</button>
          </div>
        `;
        stockList.appendChild(row);
        document.getElementById(`btn-rm-${id}`).onclick = async ()=>{
          const v = parseFloat((document.getElementById(`rm-${id}`).value||'').replace(',', '.'));
          if(!(v>0)) return;
          await adjustQty('remove', id, v);
        };
        document.getElementById(`btn-ad-${id}`).onclick = async ()=>{
          const v = parseFloat((document.getElementById(`ad-${id}`).value||'').replace(',', '.'));
          if(!(v>0)) return;
          await adjustQty('add', id, v);
        };
      }
    }catch(e){
      stockList.innerHTML = `<div class="muted">‚ùå ${e.message}</div>`;
    }
  }

  async function adjustQty(kind, stockId, qty){
    try{
      const url = kind==='add' ? '/api/stock/add_qty' : '/api/stock/remove_qty';
      await apiPOST(url, {stock_id: stockId, quantity: qty, notes: 'Kiosk adjust'});
      await refreshStock(document.getElementById('kioskPartId').value);
    }catch(e){
      alert('Adjust failed: ' + e.message);
    }
  }

  // keep Upload Part ID in sync if user manually edits selection
  selectedPartId.addEventListener('change', ()=> uploadPartId.value = selectedPartId.value);
</script>
</body>
</html>
